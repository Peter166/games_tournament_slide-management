<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tournament Admin Panel</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
  }
  
  .container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    overflow: hidden;
  }
  
  .header {
    background: #2c3e50;
    color: white;
    padding: 20px;
    text-align: center;
  }
  
  .content {
    padding: 30px;
  }
  
  .section {
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #f9f9f9;
  }
  
  .section h2 {
    color: #2c3e50;
    margin-bottom: 20px;
    font-size: 1.5em;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #555;
  }
  
  input[type="text"], input[type="time"], input[type="number"] {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.3s;
  }
  
  input[type="text"]:focus, input[type="time"]:focus, input[type="number"]:focus {
    outline: none;
    border-color: #667eea;
  }
  
  .button {
    background: #667eea;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  .button:hover {
    background: #5a6fd8;
  }
  
  .button.success {
    background: #27ae60;
  }
  
  .button.danger {
    background: #e74c3c;
  }
  
  .drop-zone {
    border: 3px dashed #ccc;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
    background: white;
  }
  
  .drop-zone:hover, .drop-zone.dragover {
    border-color: #667eea;
    background: #f0f4ff;
  }
  
  .file-input {
    display: none;
  }
  
  .current-pictures {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }
  
  .picture-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .picture-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
  }
  
  .picture-item .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 12px;
  }
  
  .status-message {
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
    display: none;
  }
  
  .status-message.success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
  }
  
  .status-message.error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
  }
  
  /* Custom Slide Editor Styles */
  .slide-editor {
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    margin-top: 20px;
  }
  
  .slide-editor-canvas {
    width: 100%;
    height: 500px;
    border: 1px solid #ccc;
    position: relative;
    background: #000;
    cursor: crosshair;
    overflow: hidden;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  
  .text-element {
    position: absolute;
    padding: 8px;
    border: 2px dashed transparent;
    cursor: move;
    user-select: none;
    min-width: 100px;
    min-height: 30px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 4px;
    font-family: Arial, sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  .text-element.editing {
    background: rgba(255, 255, 255, 0.95);
    outline: none;
    resize: both;
  }
  
  .text-element.no-background {
    background: transparent !important;
  }
  
  .text-element.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
  }
  
  .text-element .resize-handle {
    position: absolute;
    bottom: -5px;
    right: -5px;
    width: 10px;
    height: 10px;
    background: #667eea;
    cursor: se-resize;
    border-radius: 50%;
    display: none;
  }
  
  .text-element.selected .resize-handle {
    display: block;
  }
  
  .editor-tools {
    padding: 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .tool-group {
    display: flex;
    gap: 5px;
    align-items: center;
    margin-right: 20px;
  }
  
  .tool-group label {
    font-weight: 500;
    margin-right: 5px;
    font-size: 14px;
  }
  
  .editor-input {
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
  }
  
  .editor-btn {
    padding: 8px 15px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }
  
  .editor-btn:hover {
    background: #5a6fd8;
  }
  
  .editor-btn.secondary {
    background: #6c757d;
  }
  
  .editor-btn.secondary:hover {
    background: #5a6268;
  }
  
  .editor-btn.danger {
    background: #e74c3c;
  }
  
  .editor-btn.danger:hover {
    background: #c0392b;
  }
  
  .slide-preview {
    margin-top: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
  }
  
  .slide-preview h4 {
    margin-bottom: 10px;
    color: #2c3e50;
  }
  
  .preview-canvas {
    width: 100%;
    height: 200px;
    border: 1px solid #ddd;
    background: white;
    position: relative;
    overflow: hidden;
    transform: scale(0.5);
    transform-origin: top left;
  }
  
  .preview-canvas .text-element {
    border: none;
    background: transparent;
    pointer-events: none;
  }
  
  .current-settings {
    background: #e8f4fd;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    border-left: 4px solid #667eea;
  }
  
  .toggle-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .toggle-btn {
    flex: 1;
    padding: 10px;
    border: 2px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 6px;
    text-align: center;
    transition: all 0.3s;
  }
  
  .toggle-btn.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üèÜ Tournament Admin Panel</h1>
    <p>Manage countdown settings and slideshow pictures</p>
  </div>
  
  <div class="content">
    <!-- Countdown Settings Section -->
    <div class="section">
      <h2>‚è∞ Countdown Settings</h2>
      
      <div class="current-settings" id="current-settings">
        Loading current settings...
      </div>
      
      <form id="countdown-form">
        <div class="form-group">
          <label for="countdown-text">Countdown Text:</label>
          <input type="text" id="countdown-text" placeholder="e.g., Round 1 finishes in" required>
        </div>
        
        <div class="toggle-group">
          <div class="toggle-btn active" id="time-mode-btn">Set Target Time</div>
          <div class="toggle-btn" id="duration-mode-btn">Set Duration</div>
        </div>
        
        <div class="form-group" id="time-group">
          <label for="target-time">Target Time (24-hour format):</label>
          <input type="time" id="target-time">
        </div>
        
        <div class="form-group" id="duration-group" style="display: none;">
          <label for="duration">Duration (minutes):</label>
          <input type="number" id="duration" min="1" placeholder="e.g., 30">
        </div>
        
        <button type="submit" class="button">Update Countdown</button>
      </form>
      
      <div class="status-message" id="countdown-status"></div>
    </div>
    
    <!-- Custom Slide Editor Section -->
    <div class="section">
      <h2>üé® Custom First Slide Editor</h2>
      <p style="margin-bottom: 20px; color: #666;">Create a custom slide that will appear first in the slideshow, before any uploaded pictures.</p>
      
      <div class="slide-editor">
        <div class="editor-tools">
          <div class="tool-group">
            <button class="editor-btn" onclick="addTextElement()">+ Add Text</button>
          </div>
          
          <div class="tool-group">
            <label>Font Size:</label>
            <input type="number" id="font-size" class="editor-input" value="24" min="12" max="100" style="width: 60px;">
          </div>
          
          <div class="tool-group">
            <label>Text Color:</label>
            <input type="color" id="text-color" class="editor-input" value="#000000">
          </div>
          
          <div class="tool-group">
            <label>Text BG:</label>
            <input type="color" id="bg-color" class="editor-input" value="#ffffff">
            <label style="margin-left: 10px;">
              <input type="checkbox" id="no-background" style="margin-right: 5px;">
              No BG
            </label>
          </div>
          
          <div class="tool-group">
            <label>Canvas BG:</label>
            <input type="color" id="canvas-bg-color" class="editor-input" value="#000000">
          </div>
          
          <div class="tool-group">
            <label>BG Image:</label>
            <input type="file" id="bg-image-input" class="editor-input" accept="image/*" style="width: 120px;">
            <button class="editor-btn secondary" onclick="removeBgImage()">Remove</button>
          </div>
          
          <div class="tool-group">
            <button class="editor-btn secondary" onclick="clearCanvas()">Clear All</button>
            <button class="editor-btn" onclick="saveCustomSlide()">Save Slide</button>
          </div>
        </div>
        
        <div class="slide-editor-canvas" id="slide-canvas" onclick="handleCanvasClick(event)">
          <!-- Text elements will be added here dynamically -->
        </div>
      </div>
      
      <div class="slide-preview">
        <h4>Preview (50% scale):</h4>
        <div class="preview-canvas" id="preview-canvas">
          <!-- Preview content -->
        </div>
      </div>
      
      <div class="status-message" id="slide-status"></div>
    </div>
    
    <!-- Picture Upload Section -->
    <div class="section">
      <h2>üñºÔ∏è Picture Management</h2>
      
      <div class="drop-zone" id="drop-zone">
        <p>üìÅ Drop pictures here or click to select</p>
        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
          Supported formats: JPG, PNG, GIF, WebP
        </p>
      </div>
      
      <input type="file" id="file-input" class="file-input" multiple accept="image/*">
      
      <div class="status-message" id="upload-status"></div>
      
      <h3 style="margin-top: 30px; margin-bottom: 15px;">Current Pictures:</h3>
      <div class="current-pictures" id="current-pictures">
        Loading pictures...
      </div>
    </div>
  </div>
</div>

<script>
// Global variables
let currentMode = 'time'; // 'time' or 'duration'

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  loadCurrentSettings();
  loadCurrentPictures();
  loadCustomSlide();
  setupEventListeners();
});

function setupEventListeners() {
  // Form submission
  document.getElementById('countdown-form').addEventListener('submit', updateCountdown);
  
  // Toggle between time and duration modes
  document.getElementById('time-mode-btn').addEventListener('click', (e) => {
    console.log('Time mode button clicked');
    e.preventDefault();
    setMode('time');
  });
  document.getElementById('duration-mode-btn').addEventListener('click', (e) => {
    console.log('Duration mode button clicked');
    e.preventDefault();
    setMode('duration');
  });
  
  // File upload
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');
  
  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', handleDragOver);
  dropZone.addEventListener('drop', handleDrop);
  dropZone.addEventListener('dragenter', e => e.preventDefault());
  dropZone.addEventListener('dragleave', handleDragLeave);
  
  fileInput.addEventListener('change', handleFileSelect);
}

function setMode(mode) {
  console.log(`Setting mode to: ${mode}`);
  currentMode = mode;
  
  // Update button styles
  document.getElementById('time-mode-btn').classList.toggle('active', mode === 'time');
  document.getElementById('duration-mode-btn').classList.toggle('active', mode === 'duration');
  
  // Show/hide appropriate form groups
  document.getElementById('time-group').style.display = mode === 'time' ? 'block' : 'none';
  document.getElementById('duration-group').style.display = mode === 'duration' ? 'block' : 'none';
  
  console.log(`Mode set to ${mode}, time-group display: ${document.getElementById('time-group').style.display}, duration-group display: ${document.getElementById('duration-group').style.display}`);
}

async function loadCurrentSettings() {
  try {
    const response = await fetch('/api/countdown');
    if (response.ok) {
      const data = await response.json();
      
      const settingsDiv = document.getElementById('current-settings');
      settingsDiv.innerHTML = `
        <strong>Current Settings:</strong><br>
        Text: "${data.text}"<br>
        Duration: ${Math.floor(data.duration / 60)}:${String(data.duration % 60).padStart(2, '0')}<br>
        ${data.target_time ? `Target Time: ${data.target_time}` : 'No target time set'}
      `;
      
      // Pre-fill form
      document.getElementById('countdown-text').value = data.text;
      if (data.target_time) {
        document.getElementById('target-time').value = data.target_time;
        setMode('time');
      } else {
        document.getElementById('duration').value = Math.floor(data.duration / 60);
        setMode('duration');
      }
    }
  } catch (error) {
    console.error('Error loading settings:', error);
  }
}

async function updateCountdown(e) {
  e.preventDefault();
  console.log('Form submitted, current mode:', currentMode);
  
  const text = document.getElementById('countdown-text').value;
  const payload = { text };
  
  if (currentMode === 'time') {
    const targetTime = document.getElementById('target-time').value;
    console.log('Target time value:', targetTime);
    if (targetTime) {
      payload.target_time = targetTime;
    }
  } else {
    const duration = parseInt(document.getElementById('duration').value) * 60; // Convert to seconds
    console.log('Duration value:', duration);
    if (duration) {
      payload.duration = duration;
    }
  }
  
  console.log('Sending payload:', payload);
  
  try {
    const response = await fetch('/api/countdown', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    console.log('Server response:', result);
    
    if (result.success) {
      showStatus('countdown-status', 'Countdown updated successfully!', 'success');
      loadCurrentSettings();
    } else {
      showStatus('countdown-status', `Error: ${result.error}`, 'error');
    }
  } catch (error) {
    console.log('Fetch error:', error);
    showStatus('countdown-status', `Error: ${error.message}`, 'error');
  }
}

async function loadCurrentPictures() {
  try {
    const response = await fetch('/api/pictures');
    if (response.ok) {
      const data = await response.json();
      displayPictures(data.pictures);
    }
  } catch (error) {
    console.error('Error loading pictures:', error);
  }
}

function displayPictures(pictures) {
  const container = document.getElementById('current-pictures');
  
  if (pictures.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666;">No pictures uploaded yet.</p>';
    return;
  }
  
  container.innerHTML = pictures.map(picture => `
    <div class="picture-item">
      <img src="${picture}" alt="Slide picture">
      <button class="delete-btn" onclick="deletePicture('${picture.split('/').pop()}')">&times;</button>
    </div>
  `).join('');
}

function handleDragOver(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.add('dragover');
}

function handleDragLeave(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('dragover');
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('dragover');
  
  const files = Array.from(e.dataTransfer.files);
  uploadFiles(files);
}

function handleFileSelect(e) {
  const files = Array.from(e.target.files);
  uploadFiles(files);
}

async function uploadFiles(files) {
  const imageFiles = files.filter(file => file.type.startsWith('image/'));
  
  if (imageFiles.length === 0) {
    showStatus('upload-status', 'Please select valid image files.', 'error');
    return;
  }
  
  showStatus('upload-status', `Uploading ${imageFiles.length} file(s)...`, 'success');
  
  for (const file of imageFiles) {
    try {
      const formData = new FormData();
      formData.append('file', file);
      
      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (!result.success) {
        showStatus('upload-status', `Error uploading ${file.name}: ${result.error}`, 'error');
        return;
      }
    } catch (error) {
      showStatus('upload-status', `Error uploading ${file.name}: ${error.message}`, 'error');
      return;
    }
  }
  
  showStatus('upload-status', `Successfully uploaded ${imageFiles.length} file(s)!`, 'success');
  loadCurrentPictures();
  
  // Clear file input
  document.getElementById('file-input').value = '';
}

async function deletePicture(filename) {
  if (!confirm(`Are you sure you want to delete ${filename}?`)) {
    return;
  }
  
  try {
    const response = await fetch(`/api/delete/${encodeURIComponent(filename)}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showStatus('upload-status', `Deleted ${filename} successfully!`, 'success');
      loadCurrentPictures();
    } else {
      showStatus('upload-status', `Error deleting ${filename}: ${result.error}`, 'error');
    }
  } catch (error) {
    showStatus('upload-status', `Error deleting ${filename}: ${error.message}`, 'error');
  }
}

function showStatus(elementId, message, type) {
  const statusElement = document.getElementById(elementId);
  statusElement.textContent = message;
  statusElement.className = `status-message ${type}`;
  statusElement.style.display = 'block';
  
  // Hide after 5 seconds
  setTimeout(() => {
    statusElement.style.display = 'none';
  }, 5000);
}

// Custom Slide Editor Functions
let selectedElement = null;
let isDragging = false;
let isResizing = false;
let dragOffset = { x: 0, y: 0 };
let elementCounter = 0;
let currentBackgroundImage = null;

function handleCanvasClick(event) {
  if (event.target.id === 'slide-canvas') {
    // Clear selection when clicking on empty canvas
    clearSelection();
  }
}

function addTextElement() {
  const canvas = document.getElementById('slide-canvas');
  const fontSize = document.getElementById('font-size').value;
  const textColor = document.getElementById('text-color').value;
  const bgColor = document.getElementById('bg-color').value;
  const noBackground = document.getElementById('no-background').checked;
  
  const textElement = document.createElement('div');
  textElement.className = 'text-element';
  textElement.id = `text-${++elementCounter}`;
  textElement.contentEditable = true;
  textElement.innerText = 'Double-click to edit';
  textElement.style.fontSize = fontSize + 'px';
  textElement.style.color = textColor;
  
  // Handle background
  if (noBackground) {
    textElement.classList.add('no-background');
    textElement.style.backgroundColor = 'transparent';
  } else {
    textElement.style.backgroundColor = bgColor;
  }
  
  // Calculate position relative to canvas size (using percentages for proper scaling)
  const canvasRect = canvas.getBoundingClientRect();
  textElement.style.left = '5%';
  textElement.style.top = '5%';
  textElement.style.maxWidth = '90%';
  
  // Add resize handle
  const resizeHandle = document.createElement('div');
  resizeHandle.className = 'resize-handle';
  textElement.appendChild(resizeHandle);
  
  // Add event listeners
  textElement.addEventListener('click', (e) => {
    e.stopPropagation();
    selectElement(textElement);
  });
  
  textElement.addEventListener('dblclick', (e) => {
    e.stopPropagation();
    enterEditMode(textElement);
  });
  
  textElement.addEventListener('keydown', handleTextKeyDown);
  textElement.addEventListener('blur', exitEditMode);
  textElement.addEventListener('mousedown', startDrag);
  resizeHandle.addEventListener('mousedown', startResize);
  
  canvas.appendChild(textElement);
  selectElement(textElement);
  updatePreview();
}

function selectElement(element) {
  clearSelection();
  selectedElement = element;
  element.classList.add('selected');
  
  // Update form fields with selected element properties
  const fontSize = parseInt(element.style.fontSize) || 24;
  const textColor = rgbToHex(element.style.color) || '#000000';
  const bgColor = rgbToHex(element.style.backgroundColor) || '#ffffff';
  const hasNoBackground = element.classList.contains('no-background');
  
  document.getElementById('font-size').value = fontSize;
  document.getElementById('text-color').value = textColor;
  document.getElementById('bg-color').value = bgColor;
  document.getElementById('no-background').checked = hasNoBackground;
}

function enterEditMode(element) {
  element.classList.add('editing');
  element.focus();
  
  // Select all text for easy editing
  const range = document.createRange();
  range.selectNodeContents(element);
  const selection = window.getSelection();
  selection.removeAllRanges();
  selection.addRange(range);
}

function exitEditMode(element) {
  element.classList.remove('editing');
  updatePreview();
}

function handleTextKeyDown(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    
    // Insert a line break
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    
    const br = document.createElement('br');
    range.deleteContents();
    range.insertNode(br);
    
    // Move cursor after the line break
    range.setStartAfter(br);
    range.setEndAfter(br);
    selection.removeAllRanges();
    selection.addRange(range);
    
    // Auto-resize the text element if needed
    const element = e.target;
    const minHeight = parseInt(element.style.minHeight) || 30;
    if (element.scrollHeight > element.offsetHeight) {
      element.style.height = Math.max(minHeight, element.scrollHeight + 10) + 'px';
    }
    
    updatePreview();
  }
}

function clearSelection() {
  if (selectedElement) {
    selectedElement.classList.remove('selected');
    selectedElement = null;
  }
}

function startDrag(e) {
  if (e.target.className === 'resize-handle') return;
  
  isDragging = true;
  const rect = e.target.getBoundingClientRect();
  const canvasRect = document.getElementById('slide-canvas').getBoundingClientRect();
  
  dragOffset.x = e.clientX - rect.left;
  dragOffset.y = e.clientY - rect.top;
  
  e.preventDefault();
  
  document.addEventListener('mousemove', doDrag);
  document.addEventListener('mouseup', stopDrag);
}

function doDrag(e) {
  if (!isDragging || !selectedElement) return;
  
  const canvasRect = document.getElementById('slide-canvas').getBoundingClientRect();
  const x = e.clientX - canvasRect.left - dragOffset.x;
  const y = e.clientY - canvasRect.top - dragOffset.y;
  
  selectedElement.style.left = Math.max(0, Math.min(canvasRect.width - selectedElement.offsetWidth, x)) + 'px';
  selectedElement.style.top = Math.max(0, Math.min(canvasRect.height - selectedElement.offsetHeight, y)) + 'px';
  
  updatePreview();
}

function stopDrag() {
  isDragging = false;
  document.removeEventListener('mousemove', doDrag);
  document.removeEventListener('mouseup', stopDrag);
}

function startResize(e) {
  e.stopPropagation();
  isResizing = true;
  
  document.addEventListener('mousemove', doResize);
  document.addEventListener('mouseup', stopResize);
}

function doResize(e) {
  if (!isResizing || !selectedElement) return;
  
  const canvasRect = document.getElementById('slide-canvas').getBoundingClientRect();
  const elementRect = selectedElement.getBoundingClientRect();
  
  const newWidth = e.clientX - elementRect.left;
  const newHeight = e.clientY - elementRect.top;
  
  selectedElement.style.width = Math.max(100, newWidth) + 'px';
  selectedElement.style.height = Math.max(30, newHeight) + 'px';
  
  updatePreview();
}

function stopResize() {
  isResizing = false;
  document.removeEventListener('mousemove', doResize);
  document.removeEventListener('mouseup', stopResize);
}

// Update selected element properties when form fields change
document.getElementById('font-size').addEventListener('input', function() {
  if (selectedElement) {
    selectedElement.style.fontSize = this.value + 'px';
    updatePreview();
  }
});

document.getElementById('text-color').addEventListener('input', function() {
  if (selectedElement) {
    selectedElement.style.color = this.value;
    updatePreview();
  }
});

document.getElementById('bg-color').addEventListener('input', function() {
  if (selectedElement && !document.getElementById('no-background').checked) {
    selectedElement.style.backgroundColor = this.value;
    updatePreview();
  }
});

document.getElementById('no-background').addEventListener('change', function() {
  if (selectedElement) {
    if (this.checked) {
      selectedElement.classList.add('no-background');
      selectedElement.style.backgroundColor = 'transparent';
    } else {
      selectedElement.classList.remove('no-background');
      selectedElement.style.backgroundColor = document.getElementById('bg-color').value;
    }
    updatePreview();
  }
});

// Canvas background color change
document.getElementById('canvas-bg-color').addEventListener('input', function() {
  const canvas = document.getElementById('slide-canvas');
  canvas.style.backgroundColor = this.value;
  updatePreview();
});

// Background image upload
document.getElementById('bg-image-input').addEventListener('change', function() {
  if (this.files && this.files[0]) {
    uploadBackgroundImage(this.files[0]);
  }
});

function clearCanvas() {
  if (confirm('Are you sure you want to clear all text elements and remove the custom slide?')) {
    const canvas = document.getElementById('slide-canvas');
    canvas.innerHTML = '';
    canvas.style.backgroundColor = '#000000';
    canvas.style.backgroundImage = '';
    currentBackgroundImage = null;
    document.getElementById('canvas-bg-color').value = '#000000';
    document.getElementById('bg-image-input').value = '';
    clearSelection();
    updatePreview();
    
    // Clear the saved slide
    clearCustomSlide();
  }
}

async function clearCustomSlide() {
  try {
    const response = await fetch('/api/custom-slide', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      showStatus('slide-status', 'Custom slide cleared successfully!', 'success');
    } else {
      showStatus('slide-status', `Error clearing slide: ${result.error}`, 'error');
    }
  } catch (error) {
    console.error('Error clearing slide:', error);
    showStatus('slide-status', `Error clearing slide: ${error.message}`, 'error');
  }
}

async function uploadBackgroundImage(file) {
  try {
    const formData = new FormData();
    formData.append('file', file);
    
    showStatus('slide-status', 'Uploading background image...', 'success');
    
    const response = await fetch('/api/upload-background', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      currentBackgroundImage = `./pictures/main_slide_bg/${result.filename}`;
      applyBackgroundImage(currentBackgroundImage);
      showStatus('slide-status', 'Background image uploaded successfully!', 'success');
    } else {
      showStatus('slide-status', `Error: ${result.error}`, 'error');
    }
  } catch (error) {
    showStatus('slide-status', `Error uploading background: ${error.message}`, 'error');
  }
}

function applyBackgroundImage(imageUrl) {
  const canvas = document.getElementById('slide-canvas');
  canvas.style.backgroundImage = `url(${imageUrl})`;
  canvas.style.backgroundSize = 'cover';
  canvas.style.backgroundPosition = 'center';
  canvas.style.backgroundRepeat = 'no-repeat';
  updatePreview();
}

function removeBgImage() {
  if (confirm('Are you sure you want to remove the background image?')) {
    const canvas = document.getElementById('slide-canvas');
    canvas.style.backgroundImage = '';
    currentBackgroundImage = null;
    document.getElementById('bg-image-input').value = '';
    updatePreview();
  }
}

function updatePreview() {
  const canvas = document.getElementById('slide-canvas');
  const preview = document.getElementById('preview-canvas');
  
  // Copy background styling
  preview.style.backgroundColor = canvas.style.backgroundColor;
  preview.style.backgroundImage = canvas.style.backgroundImage;
  preview.style.backgroundSize = 'cover';
  preview.style.backgroundPosition = 'center';
  preview.style.backgroundRepeat = 'no-repeat';
  
  // Clone canvas content to preview
  preview.innerHTML = canvas.innerHTML;
  
  // Remove selection classes and event listeners from preview
  const previewElements = preview.querySelectorAll('.text-element');
  previewElements.forEach(el => {
    el.classList.remove('selected');
    el.contentEditable = false;
    el.style.transform = 'scale(1)'; // Ensure preview elements are not scaled
  });
}

async function saveCustomSlide() {
  const canvas = document.getElementById('slide-canvas');
  const elements = Array.from(canvas.children).map(el => {
    // Check if element has no-background class
    const hasNoBackground = el.classList.contains('no-background');
    
    return {
      id: el.id,
      text: el.innerText || el.textContent,
      left: el.style.left,
      top: el.style.top,
      width: el.style.width,
      height: el.style.height,
      fontSize: el.style.fontSize,
      color: el.style.color,
      backgroundColor: hasNoBackground ? 'transparent' : el.style.backgroundColor,
      hasNoBackground: hasNoBackground
    };
  });
  
  const slideData = {
    elements: elements,
    backgroundColor: canvas.style.backgroundColor || '#000000',
    backgroundImage: currentBackgroundImage
  };
  
  try {
    const response = await fetch('/api/custom-slide', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(slideData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      showStatus('slide-status', 'Custom slide saved successfully!', 'success');
    } else {
      showStatus('slide-status', `Error: ${result.error}`, 'error');
    }
  } catch (error) {
    showStatus('slide-status', `Error saving slide: ${error.message}`, 'error');
  }
}

async function loadCustomSlide() {
  try {
    const response = await fetch('/api/custom-slide');
    if (response.ok) {
      const data = await response.json();
      
      const canvas = document.getElementById('slide-canvas');
      canvas.innerHTML = '';
      
      // Set background color
      if (data.backgroundColor) {
        canvas.style.backgroundColor = data.backgroundColor;
        document.getElementById('canvas-bg-color').value = data.backgroundColor;
      }
      
      // Set background image
      if (data.backgroundImage) {
        currentBackgroundImage = data.backgroundImage;
        applyBackgroundImage(data.backgroundImage);
      } else {
        canvas.style.backgroundImage = '';
        currentBackgroundImage = null;
      }
      
      // Load text elements
      if (data.elements && data.elements.length > 0) {
        data.elements.forEach(elemData => {
          const textElement = document.createElement('div');
          textElement.className = 'text-element';
          textElement.id = elemData.id;
          textElement.contentEditable = true;
          textElement.innerText = elemData.text;
          
          // Apply styles
          if (elemData.left) textElement.style.left = elemData.left;
          if (elemData.top) textElement.style.top = elemData.top;
          if (elemData.width) textElement.style.width = elemData.width;
          if (elemData.height) textElement.style.height = elemData.height;
          if (elemData.fontSize) textElement.style.fontSize = elemData.fontSize;
          if (elemData.color) textElement.style.color = elemData.color;
          
          // Handle background - check if it's transparent/no background
          if (elemData.backgroundColor === 'transparent' || !elemData.backgroundColor) {
            textElement.classList.add('no-background');
            textElement.style.backgroundColor = 'transparent';
          } else {
            textElement.style.backgroundColor = elemData.backgroundColor;
          }
          
          // Add resize handle
          const resizeHandle = document.createElement('div');
          resizeHandle.className = 'resize-handle';
          textElement.appendChild(resizeHandle);
          
          // Add event listeners
          textElement.addEventListener('click', (e) => {
            e.stopPropagation();
            selectElement(textElement);
          });
          
          textElement.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            enterEditMode(textElement);
          });
          
          textElement.addEventListener('keydown', handleTextKeyDown);
          textElement.addEventListener('blur', exitEditMode);
          textElement.addEventListener('mousedown', startDrag);
          resizeHandle.addEventListener('mousedown', startResize);
          
          canvas.appendChild(textElement);
        });
      }
      
      updatePreview();
    }
  } catch (error) {
    console.error('Error loading custom slide:', error);
  }
}

// Helper function to convert RGB to hex
function rgbToHex(rgb) {
  if (!rgb) return '#000000';
  
  const result = rgb.match(/\d+/g);
  if (!result || result.length < 3) return '#000000';
  
  return '#' + result.slice(0, 3).map(x => {
    const hex = parseInt(x).toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  }).join('');
}

// Add keyboard shortcut for deleting selected element
document.addEventListener('keydown', function(e) {
  if (e.key === 'Delete' && selectedElement) {
    selectedElement.remove();
    clearSelection();
    updatePreview();
  }
});
</script>

</body>
</html>
